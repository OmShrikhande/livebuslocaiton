<!DOCTYPE html>
<html>
<head>
  <title>Real-Time Bus Tracker</title>
  <style>
    #speed-display-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background-color: #ff5722;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      height: 100vh;
      width: 100vw;
      z-index: 0;
    }
    #map-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="map-controls">
    <label for="map-type">Map Type:</label>
    <select id="map-type">
      <option value="default">Default</option>
      <option value="satellite">Satellite</option>
    </select>
  </div>
  <div id="map"></div>
  <div id="speed-display-container">
    <div id="speed-display">-- km/h</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAc_3UzizC6Y-hzI_5fDYmXiTSTwR69oac",
      authDomain: "bus-tracker-4e0fc.firebaseapp.com",
      databaseURL: "https://bus-tracker-4e0fc-default-rtdb.firebaseio.com",
      projectId: "bus-tracker-4e0fc",
      storageBucket: "bus-tracker-4e0fc.appspot.com",
      messagingSenderId: "899399291440",
      appId: "1:899399291440:web:1c4535401988d905e293f5",
      measurementId: "G-JFC5HHBVGC"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const firestore = firebase.firestore(); // Initialize Firestore
    
    let map, marker, polyline;
    let vehiclePath = [];
    let defaultLayer, satelliteLayer;
    
    function initMap() {
      map = L.map('map').setView([21.1496273646212, 79.08079485255764], 18);
      
      defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      
      satelliteLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenTopoMap contributors'
      });
      
      marker = L.marker([21.1496273646212, 79.08079485255764]).addTo(map);
      polyline = L.polyline([], { color: 'red' }).addTo(map);
      
      document.getElementById("map-type").addEventListener("change", function(event) {
        if (event.target.value === "satellite") {
          map.removeLayer(defaultLayer);
          map.addLayer(satelliteLayer);
        } else {
          map.removeLayer(satelliteLayer);
          map.addLayer(defaultLayer);
        }
      });
      
      trackLiveLocation();
      loadStops();
    }
    
    function trackLiveLocation() {
      const locationRef = database.ref('bus/Location');
      
      locationRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.Latitude || !data.Longitude) return;
    
        const newPosition = [data.Latitude, data.Longitude];
        marker.setLatLng(newPosition);
        map.setView(newPosition, 18);
        updateVehiclePath(newPosition);
        updateSpeed(data.Speed);

        // Save the new position to Firestore
        saveRouteToFirestore(data.Latitude, data.Longitude);
      }, (error) => console.error("Error fetching location data:", error));
    }
    
    function saveRouteToFirestore(latitude, longitude) {
      const routeCollection = firestore.collection('Routes'); // Firestore collection for routes
      const timestamp = new Date().toISOString(); // Current timestamp
      routeCollection.add({
        latitude,
        longitude,
        timestamp
      }).then(() => {
        console.log("Route point saved successfully:", { latitude, longitude });
      }).catch((error) => {
        console.error("Error saving route point:", error);
      });
    }
    
    function updateVehiclePath(position) {
      vehiclePath.push(position);
      polyline.setLatLngs(vehiclePath);
    }
    
    function updateSpeed(speed) {
      document.getElementById("speed-display").innerText = speed > 0 ? `${speed} km/h` : "-- km/h";
    }
    
    function loadStops() {
      const stopsCollection = firestore.collection('Locations'); // Fetching data from Firestore 'Locations' collection
      stopsCollection.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const stopName = doc.id; // Document ID as stop name
          const stopData = doc.data(); // Document data contains latitude and longitude
          if (stopData.Latitude && stopData.Longitude) {
            L.marker([stopData.Latitude, stopData.Longitude], {
              icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // New custom marker icon URL
                iconSize: [30, 30], // Adjusted size for the new icon
                iconAnchor: [15, 30] // Adjusted anchor point
              })
            }).addTo(map).bindPopup(`<b>${stopName}</b>`); // Adding marker to the map
          }
        });
      }).catch((error) => console.error("Error loading stops:", error));
    }
    
    window.onload = () => {
      console.log("Initializing map...");
      initMap();
    };
  </script>
</body>
</html>
