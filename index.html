<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Bus Tracker</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    #info-display-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 220px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      padding: 15px;
      color: white;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      text-align: center;
    }
    .info-box {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.2);
    }
    .btn {
      background: blue;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 5px;
      margin-top: 5px;
      display: block;
      width: 100%;
    }
    #reset-button {
      background: red;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="info-display-container">
    <div class="info-box">Speed: <span id="speed-display">--</span> km/h</div>
    <div class="info-box">Daily Distance: <span id="daily-distance">--</span> km</div>
    <div class="info-box">Total Distance: <span id="total-distance">--</span> km</div>
    <button id="focus-button" class="btn">Focus on Bus</button>
    <button id="reset-button" class="btn">Reset Total Distance</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const firebaseConfig = {
        apiKey: "AIzaSyAc_3UzizC6Y-hzI_5fDYmXiTSTwR69oac",
        authDomain: "bus-tracker-4e0fc.firebaseapp.com",
        databaseURL: "https://bus-tracker-4e0fc-default-rtdb.firebaseio.com",
        projectId: "bus-tracker-4e0fc",
        storageBucket: "bus-tracker-4e0fc.appspot.com",
        messagingSenderId: "899399291440",
        appId: "1:899399291440:web:1c4535401988d905e293f5"
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      
      let map, marker, routePolyline, routeCoordinates = [];
      let lastKnownLocation = [21.1496, 79.0807]; // Default location

      function initMap() {
        map = L.map('map', { zoomControl: false }).setView(lastKnownLocation, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const busIcon = L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/201/201818.png',
          iconSize: [40, 40],
          iconAnchor: [20, 20]
        });

        marker = L.marker(lastKnownLocation, { icon: busIcon }).addTo(map);
        routePolyline = L.polyline(routeCoordinates, { color: 'blue', weight: 4 }).addTo(map);
        trackLiveLocation();
      }

      function trackLiveLocation() {
        database.ref('bus').on('value', (snapshot) => {
          const data = snapshot.val();
          if (!data || !data.Location) return;

          const { Latitude, Longitude, Speed } = data.Location;
          if (Latitude && Longitude) {
            lastKnownLocation = [Latitude, Longitude]; // Save latest location
            marker.setLatLng(lastKnownLocation);
            routeCoordinates.push(lastKnownLocation);
            routePolyline.setLatLngs(routeCoordinates);
          }

          document.getElementById("speed-display").innerText = Speed ? Speed.toFixed(2) : "--";
          document.getElementById("daily-distance").innerText = data.Distance?.DailyDistance ? data.Distance.DailyDistance.toFixed(2) : "--";
          document.getElementById("total-distance").innerText = data.Distance?.TotalDistance ? data.Distance.TotalDistance.toFixed(2) : "--";
        });
      }

      document.getElementById("focus-button").addEventListener("click", () => {
        map.setView(lastKnownLocation, 18);
      });

      document.getElementById("reset-button").addEventListener("click", () => {
        database.ref('bus/Distance/TotalDistance').set(0);
        document.getElementById("total-distance").innerText = "0.00";
      });

      setTimeout(initMap, 1000);
    });
  </script>
</body>
</html>
